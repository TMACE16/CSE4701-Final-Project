name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Backend Testing
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        cd backend
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Initialize database
      run: |
        cd backend
        python db.py
    
    - name: Check database created
      run: |
        cd backend
        if [ ! -f shipping.db ]; then
          echo "Database file not created!"
          exit 1
        fi
        echo "Database created successfully"
    
    - name: Lint Python code
      run: |
        cd backend
        pip install flake8
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    
    - name: Run pytest (if tests exist)
      run: |
        cd backend
        if [ -d "tests" ]; then
          pytest tests/ -v
        else
          echo "No tests directory found, skipping pytest"
        fi
    
    - name: Test Flask app starts
      run: |
        cd backend
        timeout 10s python main.py &
        sleep 5
        curl http://localhost:8000/ || exit 1
        echo "Flask app started successfully"
  
  # Frontend Testing
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Cache Node modules
      uses: actions/cache@v3
      with:
        path: frontend/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      run: |
        cd frontend
        npm install
    
    - name: Check for TypeScript/ESLint errors
      run: |
        cd frontend
        npm run build
    
    - name: Test frontend build
      run: |
        cd frontend
        npm run build
        if [ ! -d "dist" ]; then
          echo "Build failed - no dist directory!"
          exit 1
        fi
        echo "Frontend built successfully"
  
  # Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install backend dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        python db.py
    
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm install
    
    - name: Start backend server
      run: |
        cd backend
        python main.py &
        sleep 5
    
    - name: Test API endpoints
      run: |
        # Test home endpoint
        curl -f http://localhost:8000/ || exit 1
        
        # Test services endpoint
        curl -f http://localhost:8000/api/services || exit 1
        
        echo "API endpoints responding correctly"
    
    - name: Test user registration and login
      run: |
        # Register new user
        curl -X POST http://localhost:8000/api/register \
          -H "Content-Type: application/json" \
          -d '{"email":"test@example.com","password":"testpass123","role":"customer"}' \
          || exit 1
        
        # Login with new user
        curl -X POST http://localhost:8000/api/login \
          -H "Content-Type: application/json" \
          -d '{"email":"test@example.com","password":"testpass123"}' \
          || exit 1
        
        echo "User registration and login working"
  
  # Database Schema Validation
  schema-validation:
    name: Database Schema Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
    
    - name: Initialize and validate database
      run: |
        cd backend
        python db.py
        
        # Check all required tables exist
        python << 'EOF'
        import sqlite3
        conn = sqlite3.connect('shipping.db')
        cursor = conn.cursor()
        
        required_tables = [
            'User', 'Customer', 'Package', 'ServiceType', 
            'Location', 'TrackingEvent', 'BillingStatement',
            'Payment', 'StatementPackage', 'Staff'
        ]
        
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table';")
        tables = [row[0] for row in cursor.fetchall()]
        
        missing = [t for t in required_tables if t not in tables]
        if missing:
            print(f"Missing tables: {missing}")
            exit(1)
        
        print(f"All required tables present: {tables}")
        
        # Check sample data
        cursor.execute("SELECT COUNT(*) FROM User")
        user_count = cursor.fetchone()[0]
        print(f"Users in database: {user_count}")
        
        if user_count < 3:
            print("Expected at least 3 sample users!")
            exit(1)
        
        conn.close()
        print("Database schema validation passed!")
        EOF
  
  # Security Checks
  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install safety
      run: pip install safety
    
    - name: Check Python dependencies for vulnerabilities
      run: |
        cd backend
        safety check -r requirements.txt --continue-on-error || true
    
    - name: Check for hardcoded secrets
      run: |
        # Check for common secret patterns
        if grep -r "password.*=.*['\"]" backend/*.py | grep -v "password.*get\|password.*input\|password.*TEXT"; then
          echo "Warning: Potential hardcoded passwords found"
        fi
        echo "Secret scan completed"
  
  # Code Quality
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Check for TODO/FIXME comments
      run: |
        echo "Checking for TODO/FIXME comments..."
        grep -rn "TODO\|FIXME" backend/ frontend/src/ || echo "No TODO/FIXME found"
    
    - name: Check file sizes
      run: |
        echo "Checking for large files..."
        find . -type f -size +1M -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/dist/*" | while read file; do
          echo "Large file: $file ($(du -h "$file" | cut -f1))"
        done || echo "No large files found"
    
    - name: Count lines of code
      run: |
        echo "Lines of code summary:"
        echo "Backend Python:"
        find backend -name "*.py" -not -path "*/venv/*" -not -path "*/__pycache__/*" | xargs wc -l 2>/dev/null | tail -1 || echo "No Python files"
        echo "Frontend JavaScript/JSX:"
        find frontend/src -name "*.jsx" -o -name "*.js" 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 || echo "No JS files"

  # Summary
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, integration-tests, schema-validation, security-checks, code-quality]
    if: always()
    
    steps:
    - name: Check all tests passed
      run: |
        echo "==================================="
        echo "TEST SUMMARY"
        echo "==================================="
        echo "Backend Tests: ${{ needs.backend-tests.result }}"
        echo "Frontend Tests: ${{ needs.frontend-tests.result }}"
        echo "Integration Tests: ${{ needs.integration-tests.result }}"
        echo "Schema Validation: ${{ needs.schema-validation.result }}"
        echo "Security Checks: ${{ needs.security-checks.result }}"
        echo "Code Quality: ${{ needs.code-quality.result }}"
        echo "==================================="
        
        if [ "${{ needs.backend-tests.result }}" == "success" ] && \
           [ "${{ needs.frontend-tests.result }}" == "success" ] && \
           [ "${{ needs.integration-tests.result }}" == "success" ] && \
           [ "${{ needs.schema-validation.result }}" == "success" ]; then
          echo "✅ ALL CRITICAL TESTS PASSED!"
          exit 0
        else
          echo "❌ SOME CRITICAL TESTS FAILED"
          exit 1
        fi
